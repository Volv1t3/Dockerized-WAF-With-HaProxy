# This file is for custom rules.
    # Detect SQL Injection using libinjection in JSON request bodies
    SecRule REQUEST_HEADERS:Content-Type "@contains application/json" \
      "id:999001,\
      phase:2,\
      t:none,t:lowercase,\
      log,auditlog,deny,\
      msg:'SQL Injection Attack in JSON body (libinjection)',\
      chain"

      SecRule REQUEST_BODY "@detectSQLi" "t:none"

    # Detect SQLi-like patterns in JSON body for the vulnerable endpoint
    SecRule REQUEST_URI "@beginsWith /api/vulnerable/performUserRequest" \
        "id:100010,\
        phase:2,\
        t:none,t:lowercase,t:urlDecodeUni,\
        pass,\
        log,\
        msg:'JSON SQLi-like pattern in command field for vulnerable endpoint',\
        setvar:'tx.anomaly_score_pl1=+5',\
        setvar:'tx.sql_json_detected=1',\
        chain"

        SecRule REQUEST_HEADERS:Content-Type "@contains application/json" \
            "t:none,t:lowercase,\
            chain"

            SecRule REQUEST_BODY:command "@rx (\bselect\b|\bunion\b|\bor\b\s+1\s*=\s*1\b|\bdrop\s+table\b)" \
                "t:none,t:lowercase,t:urlDecodeUni"
    # Las reglas anteriores configuran la base de las reglas manuales que creamos en la configuracion base. 
    # Las reglas debajo de esto bloquean el acceso a diferentes areas de la aplicacion para simular un deny all 
    # scenario
    # Comentario linea 37 [No se puede poner inline]: En este caso vamos a bloquear el acceso a la ruta de performUserRequest completamente
    # Comentario Linea 44 Esta regla realiza lo mismo para bloquear el acceso a la ruta de performAdminRequest
    # La idea es que esta regla bloquea de igual manera el acceso a la aplicacion.
    # En este caso vamos a bloquear el acceso a la ruta de performAdminRequest completamente

    SecRule REQUEST_URI "@contains /api/vulnerable/performUserRequest"  \
      "id:999002,\
      # Definimos Phase 1 porque analizamos el request header
      phase:1,\ 
      deny,\
      msg:'El accesso a la API por esta ruta esta negado',\
      logdata:'Se ha encontrdo una siimlltud con la regla %{MATCHED_VAR} dentro de una request hacia la api vulnerable'"
    
    SecRule REQUEST_URI "@contains /api/vulnerable/performAdminRequest"  \
      "id:999003,\
      # Definimos Phase 1 porque analizamos el request header
      phase:1,\ 
      deny,\
      msg:'El accesso a la API performAdminRequest por esta ruta esta negado',\
      logdata:'Se ha encontrdo una siimlltud con la regla %{MATCHED_VAR} dentro de una request hacia la api vulnerable'"
    
    # Ahora creemos dos reglas que no permitan el acceso a la ruta de logeo si se hace un paso por la ruta de users
        # Ahora creemos dos reglas que no permitan el acceso a la ruta de logeo si se hace un 
    # acceso previo a la ruta de /users

    # Aqui definimos el mensaje y un aspcto interesante, podemos asignar una variable a una
    # ip externa, y seguir esta variable con la request quye tenemos mientras se mantenga esta 
    # ip. En este caso estamos asignando una variable que indica si se ha accedido a la ruta de users
    # Esto le dice que luego de tres minutos se elimine la variable para que el usuario
    # pueda entrar a las rutas normales de logeo
    SecRule REQUEST_URI "@beginsWith /users" \
        "id:999004,\
        phase:1,\
        pass,\
        
        msg:'Access to users route detected - setting block flag',\
        setvar:'ip.users_accessed_user_route=1',\
        
        expirevar:'ip.users_accessed_user_route=300',\
        logdata:'IP %{REMOTE_ADDR} accessed users route'"
    # Esta regla esla contraparte de la anterior, dado que la anterior solo guarda la variable, esta segunda
    # se encarga de bloquear el acceso a las rutas de logeo o de la api mediante un error 403
    SecRule REQUEST_URI "@rx ^/(auth/sign-in|api/auth/sign-in)" \
        "id:999005,\
        phase:1,\
        pass,\
        chain"

        SecRule IP:USERS_ACCESSED_USER_ROUTE "@eq 1" \
            "deny,\
            status:403,\
            msg:'Login blocked - previous access to users route detected',\
            logdata:'IP %{REMOTE_ADDR} blocked from login after users access'"
